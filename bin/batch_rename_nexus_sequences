#! /usr/bin/env ruby

if ARGV.empty?
    puts "batch_rename_nexus_sequences mapping_file nexus_file"
    puts "  mapping_file: fichier dont la premiere colonne est le nom de sequence a remplacer, le reste est le nouveau nom"
    puts "  nexus_file: fichier nexus a traiter"
    exit 1
end

name_mapping_file = ARGV.shift
nexus_file = ARGV.shift

mapping = Hash.new
File.readlines(name_mapping_file).each do |line|
    key, *name = line.strip.split(/\s+/)
    mapping[key] = name.join(" ").strip.gsub(/[^\w]+/, '_')
end
max_key_size = mapping.values.map(&:size).max
format = "%-#{max_key_size}s"

File.readlines(nexus_file).each do |line|
    if line =~ /\[Name: (\w+)(.*)/
	name, remainder = $1, $2
	if mapped_name = mapping[name]
	    mapped_name = format % [mapped_name]
	    puts "[Name: #{mapped_name}#{remainder}"
	else
	    raise "no mapping for name #{name}"
	end
    elsif line =~ /^ (\w{8})(\s+.*)/
	name, remainder = $1, $2
	if mapped_name = mapping[name]
	    mapped_name = format % [mapped_name]
	    puts " #{mapped_name}#{remainder}"
	else
	    raise "no mapping for name #{name}"
	end
    else
	print line
    end
end

